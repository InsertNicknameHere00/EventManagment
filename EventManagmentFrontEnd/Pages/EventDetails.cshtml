@page "/EventDetails"
@model EventManagmentFrontEnd.Pages.EventDetailsModel
@{
    ViewData["Title"] = "Event Details";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - Event Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card {
            transition: all 0.3s ease;
            border: none;
        }

        .event-meta {
            font-size: 1rem;
        }

        .event-actions {
            position: sticky;
            top: 20px;
        }

        .creator-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }

        .event-details-card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .badge-large {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-calendar-alt me-2"></i>Event Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/Events">Events</a>
                    </li>
                    <li class="nav-item protected-nav" style="display: none;">
                        <a class="nav-link" href="/CreateEvent">Create Event</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item auth-nav">
                        <a class="nav-link" href="/Login">Login</a>
                    </li>
                    <li class="nav-item auth-nav">
                        <a class="nav-link" href="/Register">Register</a>
                    </li>
                    <li class="nav-item protected-nav" style="display: none;">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        <!-- Loading State -->
        <div id="loadingState" class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading event details...</p>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="row" style="display: none;">
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Event Not Found</h4>
                    <p id="errorMessage">The event you're looking for could not be found.</p>
                    <a href="/Events" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Events
                    </a>
                </div>
            </div>
        </div>

        <!-- Event Details Content -->
        <div id="eventContent" style="display: none;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <a href="/Events" class="btn btn-outline-secondary mb-2 me-2">
                                <i class="fas fa-arrow-left me-2"></i>Back to Events
                            </a>
                        </div>
                        <div id="eventActions" class="event-owner-only" style="display: none;">
                            <button class="btn btn-warning mb-2 me-2" id="editEventBtn">
                                <i class="fas fa-edit me-2"></i>Edit Event
                            </button>
                            <button class="btn btn-danger mb-2" id="deleteEventBtn" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-2"></i>Delete Event
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Event Details -->
                <div class="col-lg-8">
                    <div class="card event-details-card mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h1 class="card-title mb-0" id="eventName">Event Name</h1>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="event-meta mb-3">
                                        <i class="fas fa-calendar text-primary me-2"></i>
                                        <strong>Date & Time:</strong>
                                        <div class="ms-4" id="eventDateTime">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="event-meta mb-3">
                                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                        <strong>Location:</strong>
                                        <div class="ms-4" id="eventLocation">Loading...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4" id="eventMetaRow">
                                <div class="col-md-6">
                                    <div class="event-meta mb-3">
                                        <i class="fas fa-tag text-primary me-2"></i>
                                        <strong>Category:</strong>
                                        <div class="ms-4" id="eventCategory">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="event-meta mb-3">
                                        <i class="fas fa-users text-primary me-2"></i>
                                        <strong>Max Attendees:</strong>
                                        <div class="ms-4" id="eventMaxAttendees">Loading...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4" id="eventTypeRow">
                                <div class="event-meta mb-3">
                                    <i class="fas fa-globe text-primary me-2"></i>
                                    <strong>Event Type:</strong>
                                    <div class="ms-4" id="eventType">Loading...</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5><i class="fas fa-info-circle text-primary me-2"></i>Description</h5>
                                <div id="eventDescription" class="ms-4">Loading event description...</div>
                            </div>

                            <div id="additionalInfoSection" style="display: none;">
                                <h5><i class="fas fa-clipboard-list text-primary me-2"></i>Additional Information</h5>
                                <div id="eventAdditionalInfo" class="ms-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <div class="event-actions">
                        <!-- Creator Info -->
                        <div class="card mb-4">
                            <div class="card-body creator-info">
                                <h5 class="card-title">
                                    <i class="fas fa-user text-primary me-2"></i>Event Organizer
                                </h5>
                                <p class="mb-1"><strong>Email:</strong></p>
                                <p id="creatorEmail" class="text-muted">loading@example.com</p>
                                <p class="mb-1"><strong>Created:</strong></p>
                                <p id="eventCreatedAt" class="text-muted">Loading...</p>
                                <p class="mb-1"><strong>Last Updated:</strong></p>
                                <p id="eventUpdatedAt" class="text-muted mb-0">Loading...</p>
                            </div>
                        </div>

                        <!-- Registration Info -->
                        <div class="card mb-4" id="registrationCard">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-ticket-alt text-primary me-2"></i>Registration
                                </h5>
                                <div id="registrationInfo">
                                    <p class="mb-0">Loading registration information...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions for logged-in users -->
                        <div class="card protected-nav" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-bolt text-primary me-2"></i>Quick Actions
                                </h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" id="shareEventBtn">
                                        <i class="fas fa-share me-2"></i>Share Event
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Event Manager</h5>
                    <p class="mb-0">Your go-to platform for event management and discovery.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">&copy; 2025 Event Manager. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this event? This action cannot be undone.</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Event:</strong> <span id="deleteEventName">Event Name</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Delete Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEvent = null;
        let eventId = null;

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('id');

            if (!eventId) {
                showError('No event ID provided');
                return;
            }

            initializeAuth();
            loadEventDetails(eventId);
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('editEventBtn').addEventListener('click', function() {
                window.location.href = `/CreateEvent?id=${eventId}`;
            });
  
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteEvent);

            document.getElementById('shareEventBtn').addEventListener('click', function() {
                if (navigator.share) {
                    navigator.share({
                        title: currentEvent.name,
                        text: currentEvent.description,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        showToast('Event link copied to clipboard!', 'success');
                    });
                }
            });

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userEmail');
                    window.location.href = '/';
                });
            }
        }

        async function loadEventDetails(id) {
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`https://localhost:7286/api/Events/${id}`, { headers });
                const result = await response.json();

                if (result.success && result.data) {
                    currentEvent = result.data;
                    displayEventDetails(result.data);
                    checkEventOwnership(result.data);
                } else {
                    showError(result.message || 'Event not found');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showError('Failed to load event details');
            }
        }

        function displayEventDetails(event) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('eventContent').style.display = 'block';

            document.getElementById('eventName').textContent = event.name;
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('eventLocation').textContent = event.location;
            document.getElementById('eventDateTime').textContent = formatDateTime(event.dateTime);
            document.getElementById('creatorEmail').textContent = event.creatorEmail;
            document.getElementById('eventCreatedAt').textContent = formatDateTime(event.createdAt);
            document.getElementById('eventUpdatedAt').textContent = formatDateTime(event.updatedAt);

            if (event.category) {
                document.getElementById('eventCategory').textContent = event.category;
            } else {
                document.getElementById('eventMetaRow').children[0].style.display = 'none';
            }

            if (event.maxAttendees) {
                document.getElementById('eventMaxAttendees').textContent = event.maxAttendees;
            } else {
                document.getElementById('eventMaxAttendees').textContent = 'Unlimited';
            }

            if (event.type) {
                document.getElementById('eventType').textContent = formatEventType(event.type);
            } else {
                document.getElementById('eventTypeRow').style.display = 'none';
            }

            if (event.additionalInfo) {
                document.getElementById('eventAdditionalInfo').textContent = event.additionalInfo;
                document.getElementById('additionalInfoSection').style.display = 'block';
            }

            const registrationInfo = document.getElementById('registrationInfo');
            if (event.registrationRequired) {
                registrationInfo.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Registration required for this event
                    </div>
                `;
            } else {
                registrationInfo.innerHTML = `
                    <p class="mb-0 text-muted">
                        <i class="fas fa-door-open me-2"></i>
                        Open event - no registration required
                    </p>
                `;
            }

            document.getElementById('deleteEventName').textContent = event.name;
        }

        function checkEventOwnership(event) {
            const userEmail = localStorage.getItem('userEmail');
            const token = localStorage.getItem('token');
            
            if (token && userEmail && userEmail === event.creatorEmail) {
                document.getElementById('eventActions').style.display = 'block';
            }
        }

        async function handleDeleteEvent() {
            if (!currentEvent) return;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to delete events', 'error');
                    return;
                }

                const deleteBtn = document.getElementById('confirmDeleteBtn');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
                deleteBtn.disabled = true;

                const response = await fetch(`https://localhost:7286/api/Events/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast('Event deleted successfully!', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();
                    
                    setTimeout(() => {
                        window.location.href = '/Events';
                    }, 1500);
                } else {
                    showToast(result.message || 'Failed to delete event', 'error');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                showToast('An error occurred while deleting the event', 'error');
            } finally {
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                deleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Event';
                deleteBtn.disabled = false;
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastMessage');
            const toastBody = toast.querySelector('.toast-body');
            toastBody.textContent = message;
            
            toast.classList.remove('bg-success', 'bg-danger', 'bg-info');
            if (type === 'success') toast.classList.add('bg-success', 'text-white');
            if (type === 'error') toast.classList.add('bg-danger', 'text-white');
            if (type === 'info') toast.classList.add('bg-info', 'text-white');

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'Not specified';

            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };

            return new Date(dateTimeStr).toLocaleString('en-US', options);
        }

        function formatEventType(type) {
            const types = {
                'in-person': 'In-Person',
                'virtual': 'Virtual',
                'hybrid': 'Hybrid'
            };
            return types[type] || type;
        }

        function isAuthenticated() {
            const token = localStorage.getItem('token');
            return !!token;
        }

        function initializeAuth() {
            const token = localStorage.getItem('token');
            const isLoggedIn = !!token;
            
            document.querySelectorAll('.protected-nav').forEach(el => {
                el.style.display = isLoggedIn ? 'block' : 'none';
            });
            
            document.querySelectorAll('.auth-nav').forEach(el => {
                el.style.display = isLoggedIn ? 'none' : 'block';
            });
        }
    </script>
</body>
</html>